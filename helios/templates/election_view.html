{% extends TEMPLATE_BASE %}
{% block title %}{{election.name}}{% endblock %}

{% block content %}
	{% if admin_p %}
		{% include "partials/election_progress.html" with current="view" uuid=election.uuid %}
	{% endif %}

	<div class="row">
		<div class="large-12 columns">
			<h2>
				{{ election.name }}
				{% if admin_p %}
					{% if not election.frozen_at %}
						<small>[<a href="{% url helios.views.one_election_edit election.uuid %}">Edit</a>]</small>
					{% endif %}
				{% endif %}

				{% if admin_p %}
					{% if not election.private_p %}
						{% if can_feature_p %}
							{% if election.featured_p %}
								<small>[<a href="{% url helios.views.one_election_set_featured election.uuid %}?featured_p=0">Unfeature It</a>]</small>
							{% else %}
								<small>[<a href="{% url helios.views.one_election_set_featured election.uuid %}?featured_p=1">Feature It</a>]</small>
							{% endif %}
						{% endif %}
					{% endif %}
				{% endif %}

				{% if admin_p %}
					{% if election.is_archived %}
						<small>[<a href="{% url helios.views.one_election_archive election_uuid=election.uuid %}?archive_p=0">Unarchive It</a>]</small>
					{% else %}
						<small>[<a href="{% url helios.views.one_election_archive election_uuid=election.uuid %}?archive_p=1">Archive It</a>]</small>
					{% endif %}
				{% endif %}
			</h2>

			<div class="row">
				<div class="large-3 columns">
					<dl>
						<dt>Private</dt>
						<dd>{% if election.private_p %}Yes{% else %}No{% endif %}</dd>

						<dt>Featured</dt>
						<dd>{% if election.featured_p %}Yes{% else %}No{% endif %}</dd>

						<dt>Threshold Encryption</dt>
						<dd>{% if election.use_threshold %}Yes{% else %}No{% endif %}</dd>
					</dl>
				</div>

				<div class="large-9 columns">
					<dl>
						{% if settings.SHOW_USER_INFO %}
							<dt>Created By</dt>
							<dd>{{election.admin.display_html_small|safe}}</dd>
						{% endif %}

						{% if election.election_info_url %}
							<dt>Election Info</dt>
							<dd><a target="_blank" href="{{election.election_info_url}}">Candidate Bios and Statements</a></dd>
						{% endif %}

						{% if election.description %}
							<dt>Description</dt>
							<dd>{{election.description_bleached|safe}}</dd>
						{% endif %}
					</dl>
				</div>
			</div>

			{% if admin_p %}
				<div class="row" id="next-help">
					<div class="large-12 columns">
						<div data-alert class="alert-box info">
					  	<b>Next</b>

				  		{% if election.use_threshold %}
								{% if not election.encrypted_shares_uploaded %}
									{% if not election.frozen_trustee_list %}
										Add trustees from the communication keys list or add more communication keys.
									{% else %}
										Wait for the trustees to generate the encrypted shares.
									{% endif %}
								{% else %}
									{% if not election.result %}
										{% if not election.frozen_at %}
											{% if election.issues_before_freeze %}
												{% if election.issues_before_freeze|length > 1 %}
													{% for issue in election.issues_before_freeze %}
														{{forloop.counter}}. {{issue.action}}{% if not forloop.last %}<i class="spacer"></i>{% endif %}
													{% endfor %}
												{% else %}
													{{election.issues_before_freeze.0.action}}
												{% endif %}
											{% else %}
												<a href="{% url helios.views.one_election_freeze election.uuid %}">Freeze ballot and open election.</a>
												{% if election.voting_starts_at %}
													Once you do this, the election will be ready for voting and will open automatically at {{election.voting_starts_at}}, as per your settings.
												{% else %}
													Once you do this, the election will be immediately open for voting.
												{% endif %}
											{% endif %}
										{% else %}
											{% if not election.encrypted_tally %}
												{% if election.tallying_started_at %}
													Tally computation is under way. Reload this page in a couple of minutes.
												{% else %}
													<a href="{% url helios.views.one_election_compute_tally election.uuid %}">Compute encrypted tally.</a>
													The encrypted votes will be combined into an encrypted tally. Once this is done, trustees will be asked to provide their share of the decryption.
												{% endif %}
											{% else %}
												{% if election.ready_for_decryption_combination %}
													<a href="{% url helios.views.combine_decryptions election.uuid %}">
														{% ifequal election.num_trustees 1 %}
															Release results.
														{% else %}
															Combine trustee decryptions and release results.
														{% endifequal %}
													</a>

													{% ifequal election.num_trustees 1 %}
														The result is released and all voters are notified.
													{% else %}
														The decryption shares from the trustees are combined and the tally is decrypted. Once you do this, the tally will be immediately available for all to see, and all voters will be notified that the tally is ready.
													{% endifequal %}
												{% else %}
													<a href="{% url helios.views.trustees_list_view election.uuid %}">List of trustees (for decryption).</a>
												{% endif %}
											{% endif %}
										{% endif %}
									{% endif %}
								{% endif %}
							{% else %}
								{% if not election.result %}
									{% if not election.frozen_at %}
										{% if election.issues_before_freeze %}
											{% if election.issues_before_freeze|length > 1 %}
												{% for issue in election.issues_before_freeze %}
													{{forloop.counter}}. {{issue.action}}{% if not forloop.last %}<i class="spacer"></i>{% endif %}
												{% endfor %}
											{% else %}
												{{election.issues_before_freeze.0.action}}
											{% endif %}
										{% else %}
											<a href="{% url helios.views.one_election_freeze election.uuid %}">Freeze ballot and open election.</a>
											{% if election.voting_starts_at %}
												Once you do this, the election will be ready for voting and will open automatically at {{election.voting_starts_at}}, as per your settings.
											{% else %}
												Once you do this, the election will be immediately open for voting.
											{% endif %}
										{% endif %}
									{% else %}
										{% if not election.encrypted_tally %}
											{% if election.tallying_started_at %}
												Tally computation is under way. Reload this page in a couple of minutes.
											{% else %}
												<a href="{% url helios.views.one_election_compute_tally election.uuid %}">Compute encrypted tally.</a>
												The encrypted votes will be combined into an encrypted tally. Once this is done, trustees will be asked to provide their share of the decryption.
											{% endif %}
										{% else %}
											{% if election.ready_for_decryption_combination %}
												<a href="{% url helios.views.combine_decryptions election.uuid %}">
													{% ifequal election.num_trustees 1 %}
														Release results.
													{% else %}
														Combine trustee decryptions and release results.
													{% endifequal %}
												</a>

												{% ifequal election.num_trustees 1 %}
													The result is released and all voters are notified.
												{% else %}
													The decryption shares from the trustees are combined and the tally is decrypted. Once you do this, the tally will be immediately available for all to see, and all voters will be notified that the tally is ready.
												{% endifequal %}
											{% else %}
												<a href="{% url helios.views.trustees_list_view election.uuid %}">List of trustees (for decryption).</a>
											{% endif %}
										{% endif %}
									{% endif %}
								{% endif %}
							{% endif %}
						</div>
					</div>
				</div>
			{% endif %}
		</div>
	</div>

	<div class="row">
		<div class="large-12 columns">
			{% if admin_p %}
				{% if election.frozen_at %}
					<div class="panel callout">
						<a href="#" onclick="$('#badgebody').slideToggle(250);">Embed an Election Badge</a>

						<div id="badgebody" style="margin-top: 20px; display: none;">
							<p>Adding the following HTML to your site displays a thin banner with direct links to vote.</p>
							<textarea class="no-margin" cols="90" wrap="soft">&lt;iframe src="{{election_badge_url}}" frameborder="0" style="border: 1px solid black" height="75" width="200"&gt;&lt;/iframe&gt;</textarea>
						</div>
					</div>
				{% endif %}
			{% endif %}

			<hr />

			{% if election.result %}
				<div data-alert class="alert-box info">
	    		This election is complete.
				</div>

				<h3>Tally</h3>
				{% for question in election.pretty_result %}
					<h4>{{forloop.counter}}. {{question.question}}</h4>
					<table>
						<thead>
							<tr>
								<td>
									Answer
								</td>
								<td>
									Count
								</td>
							</tr>
						</thead>

						<tbody>
							{% if election.election_type == 'ranked election' %}
								{% for answer in question.answers %}
									<tr>
										<td style="padding-right:80px;{% if answer.winner %}font-weight:bold;{% endif %}">{{answer.answer}}</td><td align="right" style="{% if answer.winner %}font-weight:bold;{% endif %}">{{answer.score}}</td>
										<td style="{% if answer.winner %}font-weight: bold;{% endif %}">{{answer.count}}</td>
									</tr>
								{% endfor %}
							{% else %}
								{% for answer in question.answers %}
									<tr>
										<td style="padding-right:80px;{% if answer.winner %}font-weight:bold;{% endif %}">{{answer.answer}}</td>
										<td align="right" style="{% if answer.winner %}font-weight:bold;{% endif %}">{{answer.count}}</td>
									</tr>
								{% endfor %}
							{% endif %}
						</tbody>
					</table>
				{% endfor %}
			{% else %}
				{% if election.voting_has_stopped %}
					<div data-alert class="alert-box info">
						This election is closed. The tally will be computed soon.
					</div>
				{% else %}
					{% if election.voting_has_started %}
						<a class="button" href="{{test_cookie_url}}">Vote in This {{election.election_type|title}}</a>

						<dl>
							<dt>End</dt>
							<dd>
								{% if election.voting_extended_until %}
									This {{election.election_type}} was initially scheduled to end at {{election.voting_ends_at}} (UTC), but has been extended until {{ election.voting_extended_until }} (UTC).
								{% else %}
									{% if election.voting_ends_at %}
										This {{election.election_type}} is scheduled to end at {{election.voting_ends_at}} (UTC).
									{% else %}
										This {{election.election_type}} ends at the administrator's discretion.
									{% endif %}
								{% endif %}
							</dd>
						</dl>

						{% if election.private_p and voter %}
							<p>This election is <b>private</b>. You are signed in as eligible voter <i>{{voter.name}}</i>.</p>
						{% endif %}
					{% else %}
						<div data-alert class="alert-box info">
  						Voting is not yet open.
						</div>
					{% endif %}

					{% if user %}
						{% if voter %}
							<p>
  							You are registered to vote in this {{election.election_type}}.
								{% if election.use_voter_aliases %}
									Your voter alias is {{voter.alias}}.
								{% endif %}
							</p>
						{% else %}
							{% if not election.result %}
								<p>
									{% if election.openreg %}
										{% if eligible_p %}
											You are eligible to vote in this election.
										{% else %}
											You are <i>not eligible</i> to vote in this {{election.election_type}}.
										{% endif %}
									{% else %}
										You are <i>not eligible</i> to vote in this {{election.election_type}}.
									{% endif %}
								</p>
							{% endif %}
						{% endif %}
					{% else %}
						{% if election.openreg %}
							<div data-alert class="alert-box info">
								<b>Who can vote?</b>

								{% if election.eligibility %}
									{{election.pretty_eligibility|safe}}
								{% else %}
									Anyone can vote in this election.
								{% endif %}
							</div>
						{% endif %}
					{% endif %}
				{% endif %}
			{% endif %}

			<div class="panel callout">
				<a href="#" onclick="$('#auditbody').slideToggle(250);">Audit Info</a>

				<div id="auditbody" style="margin-top: 20px; display: none;">
					<p>
						<dl class="no-margin">
							<dt>Election URL</dt>
							<dd><a href="{{election.url}}">{{election.url}}</a></dd>

							{% if election.frozen_at %}
								<dt>Election Fingerprint</dt>
								<dd><tt style="font-weight: bold;">{{election.hash}}</tt></dd>

								{% if votes %}
									<dt>Your Smart Ballot Tracker</dt>
									<dd><tt style="font-weight: bold;">{{votes.0.vote_hash}}</tt></dd>
								{% endif %}
							{% endif %}
						</dl>
					</p>

					{% if election.frozen_at %}
						<a class="button no-margin" href="{% url helios.views.voters_list_pretty election.uuid %}">Ballot Tracking Center</a>
						<a class="button no-margin" href="{% url helios.views.one_election_audited_ballots election.uuid %}">Audited Ballots</a>

						{% if not election.voting_has_started %}
			  				<a class="button no-margin" href="{{SECURE_URL_HOST}}/booth/vote.html?election_url={% url helios.views.one_election election.uuid %}">Preview Booth</a>
						{% endif %}
					{% endif %}


					{% if election.voting_has_stopped %}
						{% if election.result %}
							<a class="button no-margin" target="_blank" href="/verifier/verify.html?election_url={% url helios.views.one_election election.uuid %}">Verify Election Tally</a>
						{% endif %}

						<a class="button no-margin" href="{{vote_url}}">Review the Voting Booth</a>
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	<script language="javascript">
		$(document).ready(function (){
			if ($('#next-help .alert-box').html().trim() == '<b>Next</b>')
			 	$('#next-help').remove();
		});
	</script>
{% endblock %}
